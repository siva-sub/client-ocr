import{F as k,H as w}from"./onnx-CsAy7YMg.js";const $={global:{text_score:.5,use_det:!0,use_cls:!0,use_rec:!0,min_height:30,width_height_ratio:8,max_side_len:2e3,min_side_len:30,return_word_box:!1,return_single_char_box:!1},det:{engine_type:"onnxruntime",lang_type:"en",model_type:"mobile",ocr_version:"PP-OCRv4",limit_side_len:736,limit_type:"min",std:[.5,.5,.5],mean:[.5,.5,.5],scale:1/255,thresh:.3,box_thresh:.5,max_candidates:1e3,unclip_ratio:1.6,use_dilation:!0,score_mode:"fast",padding_vertical:.4,padding_horizontal:.6,minimum_area_threshold:20},cls:{engine_type:"onnxruntime",lang_type:"en",model_type:"mobile",ocr_version:"PP-OCRv4",cls_image_shape:[3,48,192],cls_batch_num:6,cls_thresh:.9,label_list:["0","180"]},rec:{engine_type:"onnxruntime",lang_type:"en",model_type:"mobile",ocr_version:"PP-OCRv4",rec_img_shape:[3,48,320],rec_batch_num:6}},E={ch:{det:{lang_type:"ch"},cls:{lang_type:"ch"},rec:{lang_type:"ch"}},en:{det:{lang_type:"en"},cls:{lang_type:"en"},rec:{lang_type:"en"}},ja:{det:{lang_type:"ja"},cls:{lang_type:"ja"},rec:{lang_type:"ja"}},ko:{det:{lang_type:"ko"},cls:{lang_type:"ko"},rec:{lang_type:"ko"}},arabic:{det:{lang_type:"arabic"},cls:{lang_type:"arabic"},rec:{lang_type:"arabic"}},chinese_cht:{det:{lang_type:"chinese_cht"},cls:{lang_type:"chinese_cht"},rec:{lang_type:"chinese_cht"}},cyrillic:{det:{lang_type:"cyrillic"},cls:{lang_type:"cyrillic"},rec:{lang_type:"cyrillic"}},devanagari:{det:{lang_type:"devanagari"},cls:{lang_type:"devanagari"},rec:{lang_type:"devanagari"}},latin:{det:{lang_type:"latin"},cls:{lang_type:"latin"},rec:{lang_type:"latin"}},ta:{det:{lang_type:"ta"},cls:{lang_type:"ta"},rec:{lang_type:"ta"}},te:{det:{lang_type:"te"},cls:{lang_type:"te"},rec:{lang_type:"te"}},eslav:{det:{lang_type:"eslav"},cls:{lang_type:"eslav"},rec:{lang_type:"eslav"}},ka:{det:{lang_type:"ka"},cls:{lang_type:"ka"},rec:{lang_type:"ka"}}};function I(h,t){return{global:h.global,det:{...h.det,...t.det||{}},cls:{...h.cls,...t.cls||{}},rec:{...h.rec,...t.rec||{}}}}function U(h){const t=E[h]||{};return I($,t)}const d="https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/onnx",u="https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/master/onnx",C={ch:{name:"中文",code:"ch",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/ch_PP-OCRv4_det_infer.onnx`,sha256:"d2a7720d45a54257208b1e13e36a8479894cb74155a5efe29462512d42f49da9"},server:{url:`${d}/PP-OCRv4/det/ch_PP-OCRv4_det_server_infer.onnx`,sha256:"cfa39a3f298f6d3fc71789834d15da36d11a6c59b489fc16ea4733728012f786"}},"PP-OCRv5":{mobile:{url:`${u}/PP-OCRv5/det/ch_PP-OCRv5_mobile_det.onnx`,sha256:"4d97c44a20d30a81aad087d6a396b08f786c4635742afc391f6621f5c6ae78ae"},server:{url:`${u}/PP-OCRv5/det/ch_PP-OCRv5_server_det.onnx`,sha256:"0f8846b1d4bba223a2a2f9d9b44022fbc22cc019051a602b41a7fda9667e4cad"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/ch_PP-OCRv4_rec_infer.onnx`,sha256:"48fc40f24f6d2a207a2b1091d3437eb3cc3eb6b676dc3ef9c37384005483683b",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/ch_PP-OCRv4_rec_infer/ppocr_keys_v1.txt"},server:{url:`${d}/PP-OCRv4/rec/ch_PP-OCRv4_rec_server_infer.onnx`,sha256:"6a2676219be9907c7fc9cf61ebaa843bf2898777def567925b78886fcd90c07a",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/ch_PP-OCRv4_rec_infer/ppocr_keys_v1.txt"}},"PP-OCRv5":{mobile:{url:`${u}/PP-OCRv5/rec/ch_PP-OCRv5_rec_mobile_infer.onnx`,sha256:"5825fc7ebf84ae7a412be049820b4d86d77620f204a041697b0494669b1742c5",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv5/rec/ch_PP-OCRv5_rec_mobile_infer/ppocrv5_dict.txt"},server:{url:`${u}/PP-OCRv5/rec/ch_PP-OCRv5_rec_server_infer.onnx`,sha256:"e09385400eaaaef34ceff54aeb7c4f0f1fe014c27fa8b9905d4709b65746562a",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv5/rec/ch_PP-OCRv5_rec_server_infer/ppocrv5_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"ppocr_keys_v1.txt","PP-OCRv5":"ppocrv5_dict.txt"}},fonts:["FZYTK.TTF"]},en:{name:"English",code:"en",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/en_PP-OCRv3_det_infer.onnx`,sha256:"ea07c15d38ac40cd69da3c493444ec75b44ff23840553ff8ba102c1219ed39c2"}},"PP-OCRv5":{mobile:{url:`${d}/PP-OCRv4/det/en_PP-OCRv3_det_infer.onnx`,sha256:"ea07c15d38ac40cd69da3c493444ec75b44ff23840553ff8ba102c1219ed39c2"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/en_PP-OCRv4_rec_infer.onnx`,sha256:"e8770c967605983d1570cdf5352041dfb68fa0c21664f49f47b155abd3e0e318",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/en_PP-OCRv4_rec_infer/en_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"en_dict.txt"}}},ja:{name:"日本語",code:"ja",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/japan_PP-OCRv4_rec_infer.onnx`,sha256:"e1075a67dba758ecfc7ebc78a10ae61c95ac8fb66a9c86fab5541e33f085cb7a",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/japan_PP-OCRv4_rec_infer/japan_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"japan_dict.txt"}},fonts:["japan.ttc"]},ko:{name:"한국어",code:"ko",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}},"PP-OCRv5":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/korean_PP-OCRv4_rec_infer.onnx`,sha256:"ab151ba9065eccd98f884cf4d927db091be86137276392072edd4f9d43ad7426",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/korean_PP-OCRv4_rec_infer/korean_dict.txt"}},"PP-OCRv5":{mobile:{url:`${u}/PP-OCRv5/rec/korean_PP-OCRv5_rec_mobile_infer.onnx`,sha256:"cd6e2ea50f6943ca7271eb8c56a877a5a90720b7047fe9c41a2e541a25773c9b",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv5/rec/korean_PP-OCRv5_rec_mobile_infer/ppocrv5_korean_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"korean_dict.txt","PP-OCRv5":"ppocrv5_korean_dict.txt"}},fonts:["korean.ttf"]},arabic:{name:"العربية",code:"arabic",direction:"rtl",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/arabic_PP-OCRv4_rec_infer.onnx`,sha256:"4a9011bef71687bb84288dc86ad2471bd5d37b717ddf672dd156f9e7a5601bac",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/arabic_PP-OCRv4_rec_infer/arabic_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"arabic_dict.txt"}},fonts:["arabic.ttf"]},chinese_cht:{name:"繁體中文",code:"chinese_cht",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/ch_PP-OCRv4_det_infer.onnx`,sha256:"d2a7720d45a54257208b1e13e36a8479894cb74155a5efe29462512d42f49da9"},server:{url:`${d}/PP-OCRv4/det/ch_PP-OCRv4_det_server_infer.onnx`,sha256:"cfa39a3f298f6d3fc71789834d15da36d11a6c59b489fc16ea4733728012f786"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/chinese_cht_PP-OCRv3_rec_infer.onnx`,sha256:"779656d044ce388045e02ea9244724616194e63928606436cdfc6dc3c9528cc6",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/chinese_cht_PP-OCRv3_rec_infer/chinese_cht_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"chinese_cht_dict.txt"}},fonts:["chinese_cht.ttf"]},cyrillic:{name:"Кириллица",code:"cyrillic",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/cyrillic_PP-OCRv3_rec_infer.onnx`,sha256:"1efb65bdc460af1c0e8733d005b20952b17ca5aac10ddb56c968333791c5eaa3",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/cyrillic_PP-OCRv3_rec_infer/cyrillic_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"cyrillic_dict.txt"}},fonts:["cyrillic.ttf"]},devanagari:{name:"देवनागरी",code:"devanagari",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/devanagari_PP-OCRv4_rec_infer.onnx`,sha256:"a62b6148303187907aa0b0d3a0125bdc62557d07966468cab9056949e36035e8",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/devanagari_PP-OCRv4_rec_infer/devanagari_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"devanagari_dict.txt"}},fonts:["devanagari_Martel-Regular.ttf"]},latin:{name:"Latin",code:"latin",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}},"PP-OCRv5":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/latin_PP-OCRv3_rec_infer.onnx`,sha256:"e9d7a33667e8aaa702862975186adf2012e3f390cc0f9422865957125f8071cf",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/latin_PP-OCRv3_rec_infer/latin_dict.txt"}},"PP-OCRv5":{mobile:{url:`${u}/PP-OCRv5/rec/latin_PP-OCRv5_rec_mobile_infer.onnx`,sha256:"b20bd37c168a570f583afbc8cd7925603890efbcdc000a59e22c269d160b5f5a",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv5/rec/latin_PP-OCRv5_rec_mobile_infer/ppocrv5_latin_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"latin_dict.txt","PP-OCRv5":"ppocrv5_latin_dict.txt"}},fonts:["latin.ttf"]},ta:{name:"தமிழ்",code:"ta",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/ta_PP-OCRv4_rec_infer.onnx`,sha256:"f78d752148873c5fa6e4294002bfd162dbba54236e406a39665ebbda766161b5",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/ta_PP-OCRv4_rec_infer/ta_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"ta_dict.txt"}},fonts:["tamil.ttf"]},te:{name:"తెలుగు",code:"te",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/te_PP-OCRv4_rec_infer.onnx`,sha256:"e608c3be00c8a9ea2f5c667d90f379403e2568bd5c8183308a49ca093def8eff",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/te_PP-OCRv4_rec_infer/te_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"te_dict.txt"}},fonts:["telugu.ttf"]},ka:{name:"ಕನ್ನಡ",code:"ka",models:{det:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/rec/ka_PP-OCRv4_rec_infer.onnx`,sha256:"9c1e186ea1d13cf6c853e57b42d382c3961fdd6acc2409e0d0dc44defc9f152b",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv4/rec/kannada_PP-OCRv4_rec_infer/ka_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv4":"ka_dict.txt"}},fonts:["kannada.ttf"]},eslav:{name:"Eastern Slavic",code:"eslav",models:{det:{"PP-OCRv5":{mobile:{url:`${d}/PP-OCRv4/det/Multilingual_PP-OCRv3_det_infer.onnx`,sha256:"5475c6c7f4d84a6c4f32241b487435d59f126a40c023387af99732258844cdc3"}}},rec:{"PP-OCRv5":{mobile:{url:`${u}/PP-OCRv5/rec/eslav_PP-OCRv5_rec_mobile_infer.onnx`,sha256:"08705d6721849b1347d26187f15a5e362c431963a2a62bfff4feac578c489aab",dictUrl:"https://www.modelscope.cn/models/RapidAI/RapidOCR/resolve/v3.3.0/paddle/PP-OCRv5/rec/eslav_PP-OCRv5_rec_mobile_infer/ppocrv5_eslav_dict.txt"}}},cls:{"PP-OCRv4":{mobile:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}},dict:{"PP-OCRv5":"ppocrv5_eslav_dict.txt"}},fonts:["cyrillic.ttf"]}};function y(h,t="PP-OCRv4",e="mobile"){if(h==="en"&&t==="PP-OCRv4"&&e==="mobile"){const s="https://siva-sub.github.io/client-ocr/models/ppu-paddle-ocr";return{det:{url:`${s}/PP-OCRv5_mobile_det_infer.onnx`,sha256:void 0},rec:{url:`${s}/en_PP-OCRv4_mobile_rec_infer.onnx`,dictUrl:`${s}/en_dict.txt`,sha256:void 0},cls:{url:`${d}/PP-OCRv4/cls/ch_ppocr_mobile_v2.0_cls_infer.onnx`,sha256:"e47acedf663230f8863ff1ab0e64dd2d82b838fceb5957146dab185a89d6215c"}}}const o=C[h];if(!o)throw new Error(`Language ${h} not supported`);return{det:o.models.det[t]?.[e],rec:o.models.rec[t]?.[e],cls:o.models.cls[t]?.[e],dict:o.models.dict?.[t]}}function b(h){return typeof h=="string"?{url:`/models/${h}`,sha256:void 0,dictUrl:void 0,isMetaOnnx:h.includes(".meta.onnx")}:h}function A(h){return h.includes("ppu-paddle-ocr")||h.includes("PP-OCRv5_mobile_det")||h.includes("PP-OCRv4_mobile_rec")}function S(h){const t=h.split(`
`);return t.length>0&&t[t.length-1]===""&&t.pop(),t}class D{static async loadModel(t){try{const e=await k.create(t,{executionProviders:["webgl","wasm"],graphOptimizationLevel:"all"}),o=await this.extractMetadata(e);return{session:e,metadata:o}}catch(e){throw console.error("Failed to load meta ONNX model:",e),e}}static async extractMetadata(t){const e={};try{const o=t.handler?.artifacts?.onnxModel?.graph?.metadata_props;o&&o.forEach(a=>{if(a.key==="dictionary"&&a.value)e.dictionary=a.value.split(`
`).filter(c=>c.length>0),e.character=e.dictionary;else if(a.key==="shape"&&a.value)try{e.shape=JSON.parse(a.value)}catch(c){console.warn("Failed to parse shape metadata:",c)}else a.key==="version"&&a.value&&(e.version=a.value)});const s=t.metadata;s?.customMetadataMap&&(s.customMetadataMap.dictionary&&(e.dictionary=s.customMetadataMap.dictionary.split(`
`).filter(a=>a.length>0),e.character=e.dictionary),s.customMetadataMap.character&&(e.character=s.customMetadataMap.character.split(`
`).filter(a=>a.length>0),e.dictionary||(e.dictionary=e.character)))}catch(o){console.warn("Failed to extract metadata from model:",o)}return e}static hasEmbeddedDictionary(t){return!!(t.metadata.dictionary&&t.metadata.dictionary.length>0)}static async getDictionary(t,e){if(this.hasEmbeddedDictionary(t))return console.log("Using embedded dictionary from model metadata"),t.metadata.dictionary;if(e){console.log("Loading external dictionary from:",e);try{const s=await(await fetch(e)).text();return A(e)?S(s):s.split(`
`).filter(a=>a.length>0)}catch(o){throw console.error("Failed to load external dictionary:",o),o}}throw new Error("No dictionary available: model has no embedded dictionary and no fallback path provided")}}let R=null,v=null;self.addEventListener("message",async h=>{const{type:t,data:e}=h.data;switch(t){case"INIT":try{console.log("Initializing classification model:",e.modelPath),R=await D.loadModel(e.modelPath),console.log("Classification model initialized successfully"),console.log("Input names:",R.session.inputNames),console.log("Output names:",R.session.outputNames),v=e.config?.cls||{engine_type:"onnxruntime",lang_type:"en",model_type:"mobile",ocr_version:"PP-OCRv4",cls_image_shape:[3,48,192],cls_batch_num:6,cls_thresh:.9,label_list:["0","180"]},self.postMessage({type:"RESULT",data:{initialized:!0}})}catch(o){self.postMessage({type:"ERROR",error:o.message})}break;case"CLASSIFY":if(!R||!v){self.postMessage({type:"ERROR",error:"Model not initialized"});return}try{const{images:o}=e,s=[],a=v.cls_batch_num||6;for(let c=0;c<o.length;c+=a){const r=o.slice(c,c+a),n=await z(r);s.push(...n),self.postMessage({type:"PROGRESS",progress:Math.min((c+a)/o.length,1)})}self.postMessage({type:"RESULT",data:{results:s}})}catch(o){self.postMessage({type:"ERROR",error:o.message})}break}});async function z(h){if(!R||!v)throw new Error("Model not initialized");const t=[];for(const _ of h){const m=T(_.data,_.width,_.height);t.push(m)}const e=new Float32Array(t.length*t[0].data.length);t.forEach((_,m)=>{e.set(_.data,m*_.data.length)});const[o,s,a,c]=[t.length,...v.cls_image_shape],r=new w("float32",e,[o,s,a,c]),l={[R.session.inputNames[0]||"input"]:r},i=await R.session.run(l),f=[],P=i[Object.keys(i)[0]].data;for(let _=0;_<o;_++){const m=j(P,_);f.push(m)}return f}function T(h,t,e){if(!v)throw new Error("Config not initialized");const[o,s,a]=v.cls_image_shape,r=new OffscreenCanvas(a,s).getContext("2d"),n=new ImageData(new Uint8ClampedArray(h),t,e),l=new OffscreenCanvas(t,e);l.getContext("2d").putImageData(n,0,0),r.drawImage(l,0,0,t,e,0,0,a,s);const f=r.getImageData(0,0,a,s).data,p=new Float32Array(o*s*a);for(let P=0;P<s;P++)for(let _=0;_<a;_++){const m=(P*a+_)*4,g=P*a+_,x=f[m]/255,M=f[m+1]/255,L=f[m+2]/255;p[g]=(x-.5)/.5,p[s*a+g]=(M-.5)/.5,p[2*s*a+g]=(L-.5)/.5}return new w("float32",p,[1,o,s,a])}function j(h,t){if(!v)throw new Error("Config not initialized");const e=v.label_list.length,o=t*e,s=h.slice(o,o+e),a=Math.max(...s),c=s.map(P=>Math.exp(P-a)),r=c.reduce((P,_)=>P+_,0),n=c.map(P=>P/r);let l=0,i=n[0];for(let P=1;P<n.length;P++)n[P]>i&&(i=n[P],l=P);const f=v.label_list[l]==="180"?180:0,p=f===180&&i>=v.cls_thresh;return{angle:f,confidence:i,shouldRotate:p}}function W(h,t,e){const o=new Uint8ClampedArray(h.length);for(let s=0;s<e;s++)for(let a=0;a<t;a++){const c=(s*t+a)*4,r=((e-1-s)*t+(t-1-a))*4;for(let n=0;n<4;n++)o[r+n]=h[c+n]}return o}class N{cache=new Map;downloadQueue=new Map;onProgress;constructor(){this.initializeCache()}async initializeCache(){if("indexedDB"in window)try{const o=(await this.openDB()).transaction(["models"],"readonly").objectStore("models"),s=await new Promise((a,c)=>{const r=o.getAllKeys();r.onsuccess=()=>a(r.result),r.onerror=()=>c(r.error)});for(const a of s){const c=await new Promise((r,n)=>{const l=o.get(a);l.onsuccess=()=>r(l.result),l.onerror=()=>n(l.error)});c&&this.cache.set(a,c)}}catch(t){console.warn("Failed to load model cache:",t)}}async openDB(){return new Promise((t,e)=>{const o=indexedDB.open("rapidocr-models",1);o.onerror=()=>e(o.error),o.onsuccess=()=>t(o.result),o.onupgradeneeded=s=>{const a=s.target.result;a.objectStoreNames.contains("models")||a.createObjectStore("models")}})}async saveToCache(t,e){if(this.cache.set(t,e),"indexedDB"in window)try{const a=(await this.openDB()).transaction(["models"],"readwrite").objectStore("models");await new Promise((c,r)=>{const n=a.put(e,t);n.onsuccess=()=>c(),n.onerror=()=>r(n.error)})}catch(o){console.warn("Failed to save model to cache:",o)}}async downloadModel(t){if(this.cache.has(t.localPath))return this.cache.get(t.localPath);if(this.downloadQueue.has(t.localPath))return this.downloadQueue.get(t.localPath);const e=this.performDownload(t);this.downloadQueue.set(t.localPath,e);try{const o=await e;return await this.saveToCache(t.localPath,o),o}finally{this.downloadQueue.delete(t.localPath)}}async performDownload(t){const e=t.localPath.split("/").pop()||"model";try{this.reportProgress({modelName:e,progress:0,total:t.size||0,status:"downloading"});const o=await fetch(t.url);if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const s=o.headers.get("content-length"),a=s?parseInt(s,10):t.size||0,c=o.body?.getReader();if(!c)throw new Error("No response body");const r=[];let n=0;for(;;){const{done:f,value:p}=await c.read();if(f)break;r.push(p),n+=p.length,this.reportProgress({modelName:e,progress:n,total:a,status:"downloading"})}const l=new Uint8Array(n);let i=0;for(const f of r)l.set(f,i),i+=f.length;if(t.sha256&&(this.reportProgress({modelName:e,progress:n,total:a,status:"verifying"}),!await this.verifySHA256(l,t.sha256)))throw new Error("SHA256 verification failed");return this.reportProgress({modelName:e,progress:n,total:a,status:"complete"}),l.buffer}catch(o){throw this.reportProgress({modelName:e,progress:0,total:0,status:"error"}),o}}async verifySHA256(t,e){const o=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map(c=>c.toString(16).padStart(2,"0")).join("")===e.toLowerCase()}setProgressCallback(t){this.onProgress=t}reportProgress(t){this.onProgress&&this.onProgress(t)}async getModelUrls(t,e,o){const s=y(t,e,o),a={};if(s.det){const c=b(s.det);a.det={url:c.url,sha256:c.sha256,localPath:c.url.split("/").pop()||"det.onnx",size:this.estimateModelSize("det",o)}}if(s.rec){const c=b(s.rec);a.rec={url:c.url,sha256:c.sha256,dictUrl:c.dictUrl,localPath:c.url.split("/").pop()||"rec.onnx",size:this.estimateModelSize("rec",o)}}if(s.cls){const c=b(s.cls);a.cls={url:c.url,sha256:c.sha256,localPath:c.url.split("/").pop()||"cls.onnx",size:this.estimateModelSize("cls",o)}}if(s.dict){const c=s.rec?b(s.rec):null;c?.dictUrl&&(a.dict={url:c.dictUrl,localPath:c.dictUrl.split("/").pop()||"dict.txt",size:100*1024})}return a}estimateModelSize(t,e){return{det:{mobile:3145728,server:49283072},rec:{mobile:12582912,server:104857600},cls:{mobile:1572864,server:1572864}}[t]?.[e]||10*1024*1024}async areModelsCached(t,e,o){const s=y(t,e,o),a=[s.det,s.rec,s.cls].filter(c=>c!==void 0);for(const c of a){const n=b(c).url;if(!this.cache.has(n))return!1}return!0}async clearCache(){if(this.cache.clear(),"indexedDB"in window)try{const o=(await this.openDB()).transaction(["models"],"readwrite").objectStore("models");await new Promise((s,a)=>{const c=o.clear();c.onsuccess=()=>s(),c.onerror=()=>a(c.error)})}catch(t){console.warn("Failed to clear cache:",t)}}async getCacheSize(){let t=0;for(const e of this.cache.values())t+=e.byteLength;return t}async downloadDictionary(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to download dictionary: ${e.status}`);return(await e.text()).split(`
`).filter(s=>s.length>0)}catch(e){return console.error("Failed to download dictionary:",e),[]}}async downloadLanguageModels(t,e="PP-OCRv4",o="mobile",s){s&&this.setProgressCallback(s);const a=await this.getModelUrls(t,e,o),c={},r=[];return a.det&&r.push(this.downloadModel(a.det).then(n=>{c.det=n})),a.rec&&r.push(this.downloadModel(a.rec).then(n=>{c.rec=n})),a.cls&&r.push(this.downloadModel(a.cls).then(n=>{c.cls=n})),a.dict&&r.push(this.downloadDictionary(a.dict.url).then(n=>{c.dict=n})),await Promise.all(r),c}}class O{static getWordBoxes(t,e,o){if(!t||e.length===0)return[];const s=[],a=t.split("");let c="",r=[],n=0;for(let l=0;l<a.length;l++){const i=a[l];i===" "||i==="	"||i===`
`?c.length>0&&r.length>0&&(s.push({text:c,confidence:o,box:this.mergeBoxes(r),charBoxes:[...r]}),c="",r=[]):(c+=i,n<e.length&&r.push(e[n]),n++)}return c.length>0&&r.length>0&&s.push({text:c,confidence:o,box:this.mergeBoxes(r),charBoxes:[...r]}),s}static mergeBoxes(t){if(t.length===0)throw new Error("Cannot merge empty boxes array");if(t.length===1)return t[0];let e=1/0,o=-1/0,s=1/0,a=-1/0;for(const c of t)e=Math.min(e,c.topLeft.x,c.bottomLeft.x),o=Math.max(o,c.topRight.x,c.bottomRight.x),s=Math.min(s,c.topLeft.y,c.topRight.y),a=Math.max(a,c.bottomLeft.y,c.bottomRight.y);return{topLeft:{x:e,y:s},topRight:{x:o,y:s},bottomRight:{x:o,y:a},bottomLeft:{x:e,y:a}}}static approximateCharBoxes(t,e){const o=t.split("");if(o.length===0)return[];const a=Math.sqrt(Math.pow(e.topRight.x-e.topLeft.x,2)+Math.pow(e.topRight.y-e.topLeft.y,2)),c=Math.atan2(e.topRight.y-e.topLeft.y,e.topRight.x-e.topLeft.x),r=o.filter(p=>p!==" ").length,n=o.filter(p=>p===" ").length,l=a/(r+n*1.5),i=[];let f=0;for(const p of o){const P=p===" "?l*1.5:l,_={topLeft:{x:f,y:0},topRight:{x:f+P,y:0},bottomRight:{x:f+P,y:e.bottomLeft.y-e.topLeft.y},bottomLeft:{x:f,y:e.bottomLeft.y-e.topLeft.y}},m={topLeft:this.rotateAndTranslate(_.topLeft,c,e.topLeft),topRight:this.rotateAndTranslate(_.topRight,c,e.topLeft),bottomRight:this.rotateAndTranslate(_.bottomRight,c,e.topLeft),bottomLeft:this.rotateAndTranslate(_.bottomLeft,c,e.topLeft)};i.push(m),f+=P}return i}static rotateAndTranslate(t,e,o){const s=Math.cos(e),a=Math.sin(e);return{x:o.x+t.x*s-t.y*a,y:o.y+t.x*a+t.y*s}}static splitIntoLines(t,e){const o=t.split(`
`);if(o.length<=1)return[{text:t,box:e}];const a=Math.max(Math.abs(e.bottomLeft.y-e.topLeft.y),Math.abs(e.bottomRight.y-e.topRight.y))/o.length,c=[];for(let r=0;r<o.length;r++){const n=r*a;c.push({text:o[r],box:{topLeft:{x:e.topLeft.x,y:e.topLeft.y+n},topRight:{x:e.topRight.x,y:e.topRight.y+n},bottomRight:{x:e.bottomRight.x,y:e.topRight.y+n+a},bottomLeft:{x:e.bottomLeft.x,y:e.topLeft.y+n+a}}})}return c}}class B{config;workers={};modelPaths;onProgress;modelDownloader;enableWordBoxes;constructor(t={}){const{lang:e="en",version:o="PP-OCRv4",modelType:s="mobile",config:a={},modelBasePath:c="/models",enableWordBoxes:r=!1}=t,n=U(e);this.config={global:{...n.global,...a.global},det:{...n.det,...a.det,ocr_version:o,model_type:s},cls:{...n.cls,...a.cls,ocr_version:o,model_type:s},rec:{...n.rec,...a.rec,ocr_version:o,model_type:s}},this.modelPaths=y(e,o,s);const l=this.modelPaths.rec;if(this.modelPaths.det){const i=typeof this.modelPaths.det=="string"?this.modelPaths.det:this.modelPaths.det.url;this.modelPaths.det=i.startsWith("http")?i:`${c}/${i}`}if(this.modelPaths.rec){const i=typeof this.modelPaths.rec=="string"?this.modelPaths.rec:this.modelPaths.rec.url;this.modelPaths.rec=i.startsWith("http")?i:`${c}/${i}`}if(this.modelPaths.cls){const i=typeof this.modelPaths.cls=="string"?this.modelPaths.cls:this.modelPaths.cls.url;this.modelPaths.cls=i.startsWith("http")?i:`${c}/${i}`}l&&typeof l=="object"&&l.dictUrl?this.modelPaths.dict=l.dictUrl:this.modelPaths.dict&&(this.modelPaths.dict=`${c}/${this.modelPaths.dict}`),this.modelDownloader=new N,this.enableWordBoxes=r}async initialize(){const t=[];this.config.global.use_det&&this.modelPaths.det&&(this.workers.detection=new Worker(new URL("/client-ocr/assets/detection.worker.v2-DKtXKk48.js",import.meta.url),{type:"module"}),t.push(this.initWorker(this.workers.detection,{type:"INIT",data:{modelPath:this.modelPaths.det,config:this.config}}))),this.config.global.use_cls&&this.modelPaths.cls&&(this.workers.classification=new Worker(new URL("/client-ocr/assets/classification.worker.v2-Cqw-REfv.js",import.meta.url),{type:"module"}),t.push(this.initWorker(this.workers.classification,{type:"INIT",data:{modelPath:this.modelPaths.cls,config:this.config}}))),this.config.global.use_rec&&this.modelPaths.rec&&(this.workers.recognition=new Worker(new URL("/client-ocr/assets/recognition.worker.v2-Bezg6hKL.js",import.meta.url),{type:"module"}),t.push(this.initWorker(this.workers.recognition,{type:"INIT",data:{modelPath:this.modelPaths.rec,dictPath:this.modelPaths.dict,config:this.config}}))),await Promise.all(t)}async process(t,e,o){const s=[];let a=[];if(this.config.global.use_det&&this.workers.detection?(this.reportProgress("detection",0),a=await this.detect(t,e,o),this.reportProgress("detection",1)):a=[{topLeft:{x:0,y:0},topRight:{x:e,y:0},bottomRight:{x:e,y:o},bottomLeft:{x:0,y:o}}],a.length===0)return s;const c=a.map(l=>this.cropImage(t,e,o,l));let r=c;const n=new Array(c.length).fill(0);if(this.config.global.use_cls&&this.workers.classification){this.reportProgress("classification",0);const l=await this.classify(c);r=c.map((i,f)=>{const{shouldRotate:p,angle:P}=l[f];return n[f]=P,p?{data:W(i.data,i.width,i.height),width:i.width,height:i.height}:i}),this.reportProgress("classification",1)}if(this.config.global.use_rec&&this.workers.recognition){this.reportProgress("recognition",0);const l=await this.recognize(r,a);for(let i=0;i<a.length;i++){const{text:f,confidence:p}=l[i];if(p>=this.config.global.text_score){const P={text:f,confidence:p,box:a[i],angle:n[i]};if(this.enableWordBoxes&&f.includes(" ")){const _=O.approximateCharBoxes(f,a[i]),m=O.getWordBoxes(f,_,p);P.words=m.map(g=>({text:g.text,confidence:g.confidence,box:g.box}))}s.push(P)}}this.reportProgress("recognition",1)}return this.sortResults(s)}setProgressCallback(t){this.onProgress=t}setDownloadProgressCallback(t){this.modelDownloader.setProgressCallback(t)}async areModelsAvailable(){const t=this.config.det.lang_type,e=this.config.det.ocr_version,o=this.config.det.model_type;return this.modelDownloader.areModelsCached(t,e,o)}async downloadModels(){const t=this.config.det.lang_type,e=this.config.det.ocr_version,o=this.config.det.model_type,s=await this.modelDownloader.getModelUrls(t,e,o),a=[];this.config.global.use_det&&s.det&&a.push(this.modelDownloader.downloadModel(s.det).then(()=>{})),this.config.global.use_cls&&s.cls&&a.push(this.modelDownloader.downloadModel(s.cls).then(()=>{})),this.config.global.use_rec&&s.rec&&a.push(this.modelDownloader.downloadModel(s.rec).then(()=>{})),s.dict&&typeof this.modelPaths.rec=="string"&&!this.modelPaths.rec.includes("meta.onnx")&&a.push(this.modelDownloader.downloadModel(s.dict).then(()=>{})),await Promise.all(a)}dispose(){Object.values(this.workers).forEach(t=>{t?.terminate()}),this.workers={}}async initWorker(t,e){return new Promise((o,s)=>{const a=c=>{c.data.type==="RESULT"?(t.removeEventListener("message",a),o()):c.data.type==="ERROR"&&(t.removeEventListener("message",a),s(new Error(c.data.error)))};t.addEventListener("message",a),t.postMessage(e)})}async detect(t,e,o){return this.workers.detection?new Promise((s,a)=>{const c=r=>{r.data.type==="RESULT"?(this.workers.detection.removeEventListener("message",c),s(r.data.data.boxes||[])):r.data.type==="ERROR"&&(this.workers.detection.removeEventListener("message",c),a(new Error(r.data.error)))};this.workers.detection.addEventListener("message",c),this.workers.detection.postMessage({type:"DETECT",data:{imageData:t,width:e,height:o}})}):[]}async classify(t){return this.workers.classification?new Promise((e,o)=>{const s=a=>{a.data.type==="RESULT"?(this.workers.classification.removeEventListener("message",s),e(a.data.data.results||[])):a.data.type==="ERROR"?(this.workers.classification.removeEventListener("message",s),o(new Error(a.data.error))):a.data.type==="PROGRESS"&&this.reportProgress("classification",a.data.progress)};this.workers.classification.addEventListener("message",s),this.workers.classification.postMessage({type:"CLASSIFY",data:{images:t}})}):t.map(()=>({angle:0,confidence:1,shouldRotate:!1}))}async recognize(t,e){if(!this.workers.recognition)return t.map(()=>({text:"",confidence:0}));const o=t[0].data,s=Math.max(...e.map(c=>Math.max(c.topRight.x,c.bottomRight.x))),a=Math.max(...e.map(c=>Math.max(c.bottomLeft.y,c.bottomRight.y)));return new Promise((c,r)=>{const n=l=>{if(l.data.type==="RESULT"){this.workers.recognition.removeEventListener("message",n);const i=l.data.data.results||[];c(i.map(f=>({text:f.text,confidence:f.confidence})))}else l.data.type==="ERROR"?(this.workers.recognition.removeEventListener("message",n),r(new Error(l.data.error))):l.data.type==="PROGRESS"&&this.reportProgress("recognition",l.data.progress)};this.workers.recognition.addEventListener("message",n),this.workers.recognition.postMessage({type:"PROCESS",data:{imageData:o,width:s,height:a,boxes:e}})})}cropImage(t,e,o,s){const a=Math.min(s.topLeft.x,s.bottomLeft.x),c=Math.max(s.topRight.x,s.bottomRight.x),r=Math.min(s.topLeft.y,s.topRight.y),n=Math.max(s.bottomLeft.y,s.bottomRight.y),l=Math.round(c-a),i=Math.round(n-r),f=new Uint8ClampedArray(l*i*4);for(let p=0;p<i;p++)for(let P=0;P<l;P++){const _=((Math.round(r)+p)*e+Math.round(a)+P)*4,m=(p*l+P)*4;for(let g=0;g<4;g++)f[m+g]=t[_+g]}return{data:f,width:l,height:i}}sortResults(t){return t.sort((e,o)=>{const s=Math.min(e.box.topLeft.y,e.box.topRight.y),a=Math.min(o.box.topLeft.y,o.box.topRight.y);if(Math.abs(s-a)<10){const c=Math.min(e.box.topLeft.x,e.box.bottomLeft.x),r=Math.min(o.box.topLeft.x,o.box.bottomLeft.x);return c-r}return s-a})}reportProgress(t,e){this.onProgress&&this.onProgress({stage:t,progress:e})}static getAvailableLanguages(){return Object.entries(C).map(([t,e])=>({code:t,name:e.name}))}static isLanguageSupported(t,e="PP-OCRv4"){const o=C[t];return o&&o.models.rec[e]!==void 0}}export{B as R};
